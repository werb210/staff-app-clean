// app.js
// ---------------------------------------------------------
// Core Express App
// Staff Backend (Silo-aware)
// ---------------------------------------------------------

import "dotenv/config";
import express from "express";
import cors from "cors";
import helmet from "helmet";
import compression from "compression";
import bodyParser from "body-parser";
import morgan from "morgan";

import serverPackageJson from "../package.json" with { type: "json" };

import apiRouter from "./routes/index.js";
import pipelineRouter from "./routes/pipeline.routes.js";

import { errorHandler } from "./middlewares/errorHandler.js";
import { siloGuard } from "./middlewares/index.js";

import { db, describeDatabaseUrl } from "./services/db.js";

const app = express();
const SERVICE_NAME = "staff-backend";

// ---------------------------------------------------------
// Required ENV validation
// ---------------------------------------------------------
const requiredEnv = ["DATABASE_URL", "JWT_SECRET"];
for (const key of requiredEnv) {
  if (!process.env[key]) {
    console.error(`❌ Missing required env var: ${key}`);
    process.exit(1);
  }
}

// ---------------------------------------------------------
// Global middleware
// ---------------------------------------------------------
app.use(cors({ origin: true, credentials: true }));
app.use(helmet());
app.use(compression());
app.use(bodyParser.json({ limit: "25mb" }));
app.use(bodyParser.urlencoded({ extended: true }));
app.use(morgan("combined"));

// ---------------------------------------------------------
// Root route
// ---------------------------------------------------------
app.get("/", (_req, res) => {
  res.send("Boreal Financial — Staff Backend (Silo mode active)");
});

// ---------------------------------------------------------
// Internal health routes
// ---------------------------------------------------------
app.get("/api/_int/health", (_req, res) => {
  res.status(200).json({
    ok: true,
    time: new Date().toISOString(),
    service: SERVICE_NAME,
  });
});

app.get("/api/_int/build", (_req, res) => {
  res.status(200).json({
    ok: true,
    service: SERVICE_NAME,
    version: serverPackageJson.version ?? "0.0.0",
    environment: process.env.NODE_ENV ?? "development",
    node: process.version,
    commit: process.env.GIT_COMMIT_SHA ?? null,
    buildTime: process.env.BUILD_TIME ?? new Date().toISOString(),
  });
});

app.get("/api/_int/db", (_req, res) => {
  const metadata = describeDatabaseUrl(process.env.DATABASE_URL);
  if (metadata.status !== "ok") {
    return res.status(500).json({ ok: false, status: metadata.status });
  }

  res.status(200).json({
    ok: true,
    connection: {
      driver: metadata.driver,
      url: metadata.sanitizedUrl,
      host: metadata.host,
      port: metadata.port,
    },
    tables: {
      applications: db.applications.data.length,
      documents: db.documents.data.length,
      lenders: db.lenders.data.length,
      pipeline: db.pipeline.data.length,
      communications: db.communications.data.length,
      notifications: db.notifications.data.length,
      users: db.users.data.length,
      auditLogs: db.auditLogs.length,
    },
  });
});

app.get("/api/_int/routes", (_req, res) => {
  res.status(200).json({
    ok: true,
    mounted: [
      "/api/auth",
      "/api/contacts",
      "/api/companies",
      "/api/deals",
      "/api/documents",
      "/api/comm",
      "/api/ai",
      "/api/pipeline",
      "/api/:silo/pipeline",
    ],
  });
});

// ---------------------------------------------------------
// Silo-aware pipeline routes
// Mounted BEFORE /api to avoid overlap
// ---------------------------------------------------------
app.use("/api/:silo/pipeline", siloGuard, pipelineRouter);

// ---------------------------------------------------------
// Main API Router
// ---------------------------------------------------------
app.use("/api", apiRouter);

// ---------------------------------------------------------
// Global error handler
// ---------------------------------------------------------
app.use(errorHandler);

export default app;
