generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Silo {
  BF
  BI
  SLF
}

enum CommunicationType {
  SMS
  CALL
  EMAIL
}

enum CommunicationDirection {
  INBOUND
  OUTBOUND
}

enum DocumentStatus {
  pending
  accepted
  rejected
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  passwordHash String
  role         String
  silos     Silo[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applications Application[]
  communications CommunicationLog[]
}

model Application {
  id             String   @id @default(uuid())
  externalId     String?  @unique
  businessName   String
  applicantName  String
  applicantPhone String
  silo           Silo
  status         String   @default("new")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  documents Document[]
  user      User?      @relation(fields: [userId], references: [id])
  userId    String?
}

model Document {
  id             String         @id @default(uuid())
  applicationId  String
  documentType   String?
  fileName       String
  mimeType       String
  sizeBytes      Int
  checksum       String
  blobPath       String
  blobUrl        String
  status         DocumentStatus @default(pending)
  version        Int            @default(1)
  uploadedBy     String?
  note           String?
  aiSummary      String?
  explainability Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  application Application       @relation(fields: [applicationId], references: [id])
  versions    DocumentVersion[]
}

model DocumentVersion {
  id         String   @id @default(uuid())
  documentId String
  version    Int
  fileName   String
  mimeType   String
  sizeBytes  Int
  checksum   String
  blobPath   String
  blobUrl    String
  uploadedBy String?
  note       String?
  createdAt  DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id])

  @@unique([documentId, version])
}

model Contact {
  id        String   @id @default(uuid())
  firstName String
  lastName  String
  email     String?
  phone     String?
  silo      Silo
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  communications CommunicationLog[]
}

model Company {
  id        String   @id @default(uuid())
  name      String
  industry  String?
  silo      Silo
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Deal {
  id        String   @id @default(uuid())
  name      String
  stage     String   @default("new")
  value     Int?
  silo      Silo
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CommunicationLog {
  id                String                 @id @default(uuid())
  type              CommunicationType
  direction         CommunicationDirection
  contactId         String
  contact           Contact                @relation(fields: [contactId], references: [id])
  silo              Silo
  messageBody       String?
  subject           String?
  providerMessageId String?
  sentBy            String?
  user              User?                  @relation(fields: [sentBy], references: [id])
  createdAt         DateTime               @default(now())

  @@index([contactId, createdAt])
  @@index([silo, createdAt])
}
